<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการโครงการ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --light-bg: #f8f9fa;
        }
        
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1a2530 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem 1.25rem;
            font-weight: 600;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background-color: #f1f5f9;
            color: var(--primary-color);
            font-weight: 600;
            padding: 12px 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .data-table tr:hover {
            background-color: #f8fafc;
        }
        
        .badge-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-verified {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-box input {
            padding-left: 40px;
            border-radius: 50px;
            border: 1px solid #ddd;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #777;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 1.5rem;
        }
        
        .filter-btn {
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .tab-container {
            margin-bottom: 1.5rem;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background-color: #e9ecef;
            border: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background-color: white;
            color: var(--primary-color);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        
        .sheet-info {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }
        
        .api-key-input {
            max-width: 500px;
            margin: 0 auto 20px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .data-table th, .data-table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-project-diagram me-2"></i>ระบบจัดการโครงการ</h1>
                    <p class="mb-0">แสดงข้อมูลจาก Google Sheets: สมัครโครงการทั้งหมด, Dataโครงการตรวจแล้ว, Dataการตรวจ</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="sheet-info">
                        <i class="fas fa-sync-alt me-1"></i>ข้อมูลอัปเดตล่าสุด: <span id="last-update">กำลังโหลด...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- API Key Input (for development) -->
        <div class="card api-key-card" id="api-key-section">
            <div class="card-header">
                <i class="fas fa-key me-2"></i>ตั้งค่า Google Sheets API Key
            </div>
            <div class="card-body">
                <p class="text-muted">กรุณากรอก Google Sheets API Key ของคุณเพื่อดึงข้อมูล (เลือกวิธีใดวิธีหนึ่ง)</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>วิธีที่ 1: ใช้ API Key โดยตรง</h6>
                        <div class="mb-3">
                            <label for="api-key-input" class="form-label">Google Sheets API Key:</label>
                            <input type="password" id="api-key-input" class="form-control" placeholder="ป้อน API Key ของคุณ">
                            <div class="form-text">สามารถสร้างได้ที่ <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></div>
                        </div>
                        <button class="btn btn-primary" id="save-api-key">
                            <i class="fas fa-save me-1"></i>บันทึก API Key
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>วิธีที่ 2: เผยแพร่เป็นสาธารณะ (ง่ายกว่า)</h6>
                        <p class="small">ใน Google Sheets ของคุณ:</p>
                        <ol class="small">
                            <li>ไปที่ File → Share → Publish to web</li>
                            <li>เลือก "Entire document" และ "Web page"</li>
                            <li>คลิก Publish และคัดลอกลิงก์</li>
                        </ol>
                        <button class="btn btn-outline-primary" id="use-public-method">
                            <i class="fas fa-globe me-1"></i>ใช้วิธีการเผยแพร่สาธารณะ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-container" id="main-tabs" style="display: none;">
            <button class="tab-btn active" data-sheet="สมัครโครงการทั้งหมด">
                <i class="fas fa-list me-1"></i>สมัครโครงการทั้งหมด
            </button>
            <button class="tab-btn" data-sheet="Dataโครงการตรวจแล้ว">
                <i class="fas fa-check-circle me-1"></i>โครงการตรวจแล้ว
            </button>
            <button class="tab-btn" data-sheet="Dataการตรวจ">
                <i class="fas fa-search me-1"></i>ข้อมูลการตรวจ
            </button>
        </div>

        <!-- Search and Filter -->
        <div class="card" id="search-filter-section" style="display: none;">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-input" class="form-control" placeholder="ค้นหาข้อมูลในตาราง...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="status-filter" class="form-select">
                            <option value="all">ทั้งหมด</option>
                            <option value="รอ">รอตรวจสอบ</option>
                            <option value="อนุมัติ">อนุมัติแล้ว</option>
                            <option value="ไม่อนุมัติ">ไม่อนุมัติ</option>
                            <option value="ตรวจ">ตรวจสอบแล้ว</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-buttons">
                    <button class="btn btn-outline-primary filter-btn active" data-filter="all">ทั้งหมด</button>
                    <button class="btn btn-outline-primary filter-btn" data-filter="recent">ล่าสุด</button>
                    <button class="btn btn-outline-primary filter-btn" data-filter="budget-high">งบสูง</button>
                    <button class="btn btn-outline-primary filter-btn" data-filter="budget-low">งบต่ำ</button>
                </div>
            </div>
        </div>

        <!-- Data Display -->
        <div class="card" id="data-display-section" style="display: none;">
            <div class="card-header">
                <i class="fas fa-table me-2"></i><span id="table-title">สมัครโครงการทั้งหมด</span>
                <span class="badge bg-secondary ms-2" id="record-count">0 รายการ</span>
            </div>
            <div class="card-body p-0">
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">กำลังโหลด...</span>
                    </div>
                    <p class="mt-2">กำลังโหลดข้อมูลจาก Google Sheets...</p>
                </div>
                
                <!-- Data Table -->
                <div class="table-container p-3">
                    <table class="data-table" id="data-table">
                        <thead>
                            <tr id="table-headers">
                                <!-- Headers will be populated by JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">ไม่พบข้อมูล</h4>
                        <p class="text-muted">ลองเปลี่ยนคำค้นหาหรือตัวกรองดู</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Project Details Modal -->
        <div class="modal fade" id="projectDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">รายละเอียดโครงการ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="project-details-content">
                        <!-- Details will be populated by JavaScript -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <p>ระบบแสดงข้อมูลจาก Google Sheets | สร้างสำหรับ GitHub Pages</p>
            <p class="small">Sheet ID: 12TQKzC0ElmjCGfxz7dqW8ueO8X7Ynpcu9cpTYKUYRtM</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const SHEET_ID = '12TQKzC0ElmjCGfxz7dqW8ueO8X7Ynpcu9cpTYKUYRtM';
        
        // These are the sheet names from your URL (gid values)
        const SHEET_GIDS = {
            'สมัครโครงการทั้งหมด': '742878785',  // gid from your URL
            'Dataโครงการตรวจแล้ว': '0',          // default gid for first sheet
            'Dataการตรวจ': '0'                   // default gid for first sheet
        };
        
        // Alternative: use sheet names if gid doesn't work
        const SHEET_NAMES = {
            'สมัครโครงการทั้งหมด': 'Sheet1',
            'Dataโครงการตรวจแล้ว': 'Dataโครงการตรวจแล้ว', 
            'Dataการตรวจ': 'Dataการตรวจ'
        };
        
        // Current state
        let currentSheet = 'สมัครโครงการทั้งหมด';
        let allData = {
            'สมัครโครงการทั้งหมด': [],
            'Dataโครงการตรวจแล้ว': [],
            'Dataการตรวจ': []
        };
        let filteredData = [];
        let apiKey = '';
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check for saved API key
            const savedApiKey = localStorage.getItem('googleSheetsApiKey');
            if (savedApiKey) {
                apiKey = savedApiKey;
                document.getElementById('api-key-input').value = savedApiKey;
                hideApiKeySection();
                loadAllSheetsData();
            }
            
            // Set up event listeners
            document.getElementById('save-api-key').addEventListener('click', saveApiKey);
            document.getElementById('use-public-method').addEventListener('click', usePublicMethod);
            document.getElementById('search-input').addEventListener('input', filterData);
            document.getElementById('status-filter').addEventListener('change', filterData);
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active tab
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Switch sheet
                    currentSheet = this.getAttribute('data-sheet');
                    
                    // Update table title
                    document.getElementById('table-title').textContent = currentSheet;
                    
                    // Display data for current sheet
                    displayData();
                });
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterData();
                });
            });
            
            // Auto-refresh data every 5 minutes if API key is set
            if (apiKey) {
                setInterval(loadAllSheetsData, 5 * 60 * 1000);
            }
        });
        
        // Save API key
        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            apiKey = input.value.trim();
            
            if (!apiKey) {
                showError('กรุณากรอก API Key');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('googleSheetsApiKey', apiKey);
            
            // Hide API key section and show main interface
            hideApiKeySection();
            
            // Load data
            loadAllSheetsData();
            
            showSuccess('บันทึก API Key สำเร็จแล้ว');
        }
        
        // Use public method (publish to web)
        function usePublicMethod() {
            apiKey = 'PUBLIC';
            localStorage.setItem('googleSheetsApiKey', 'PUBLIC');
            hideApiKeySection();
            loadAllSheetsData();
        }
        
        // Hide API key section and show main interface
        function hideApiKeySection() {
            document.getElementById('api-key-section').style.display = 'none';
            document.getElementById('main-tabs').style.display = 'block';
            document.getElementById('search-filter-section').style.display = 'block';
            document.getElementById('data-display-section').style.display = 'block';
        }
        
        // Load data from all Google Sheets
        async function loadAllSheetsData() {
            showLoading(true);
            
            try {
                // Load data for each sheet
                for (const sheetName of Object.keys(allData)) {
                    const data = await fetchSheetData(sheetName);
                    allData[sheetName] = data;
                }
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('th-TH');
                
                // Display current sheet data
                displayData();
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading data:', error);
                showError('ไม่สามารถโหลดข้อมูลได้: ' + error.message);
                showLoading(false);
            }
        }
        
        // Fetch data from Google Sheets
        async function fetchSheetData(sheetName) {
            let url;
            
            if (apiKey === 'PUBLIC') {
                // Method 1: Use published sheet (no API key needed)
                // Note: This only works if the sheet is published to web
                url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
                
                try {
                    const response = await fetch(url);
                    const csvText = await response.text();
                    return parseCSV(csvText);
                } catch (error) {
                    // If published method fails, show error
                    throw new Error('กรุณาเผยแพร่ Google Sheets เป็นสาธารณะ (File → Share → Publish to web)');
                }
            } else {
                // Method 2: Use Google Sheets API v4
                const gid = SHEET_GIDS[sheetName];
                const range = encodeURIComponent(SHEET_NAMES[sheetName]);
                
                url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${apiKey}`;
                
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('API Key ไม่ถูกต้องหรือไม่มีสิทธิ์เข้าถึง');
                        } else if (response.status === 404) {
                            throw new Error('ไม่พบ Google Sheets นี้ กรุณาตรวจสอบ Sheet ID');
                        }
                        throw new Error(`ข้อผิดพลาด: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.values || data.values.length === 0) {
                        return [];
                    }
                    
                    return parseSheetData(data.values);
                } catch (error) {
                    console.error(`Error fetching ${sheetName}:`, error);
                    
                    // Try alternative method with gid
                    if (gid && gid !== '0') {
                        try {
                            const altUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
                            const altResponse = await fetch(altUrl);
                            const jsonText = await altResponse.text();
                            
                            // Extract JSON from the response (Google wraps it)
                            const jsonStart = jsonText.indexOf('{');
                            const jsonEnd = jsonText.lastIndexOf('}') + 1;
                            const jsonData = JSON.parse(jsonText.substring(jsonStart, jsonEnd));
                            
                            return parseGoogleVizData(jsonData);
                        } catch (altError) {
                            console.error('Alternative method also failed:', altError);
                        }
                    }
                    
                    throw error;
                }
            }
        }
        
        // Parse Google Sheets API v4 data
        function parseSheetData(rows) {
            if (rows.length === 0) return [];
            
            const headers = rows[0];
            const data = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const item = {};
                
                headers.forEach((header, index) => {
                    // Clean up header names
                    const cleanHeader = header.trim();
                    item[cleanHeader] = row[index] || '';
                });
                
                // Add an ID if not present
                if (!item.id && !item.ID && !item.รหัส) {
                    item.id = `row-${i}`;
                }
                
                data.push(item);
            }
            
            return data;
        }
        
        // Parse CSV data (for published sheets)
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const item = {};
                
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });
                
                // Add an ID if not present
                if (!item.id && !item.ID && !item.รหัส) {
                    item.id = `row-${i}`;
                }
                
                data.push(item);
            }
            
            return data;
        }
        
        // Parse Google Visualization API data
        function parseGoogleVizData(vizData) {
            if (!vizData.table || !vizData.table.cols || !vizData.table.rows) {
                return [];
            }
            
            const headers = vizData.table.cols.map(col => col.label);
            const data = [];
            
            vizData.table.rows.forEach((row, rowIndex) => {
                const item = {};
                
                headers.forEach((header, colIndex) => {
                    if (row.c && row.c[colIndex]) {
                        item[header] = row.c[colIndex].v || '';
                    } else {
                        item[header] = '';
                    }
                });
                
                // Add an ID if not present
                if (!item.id && !item.ID && !item.รหัส) {
                    item.id = `row-${rowIndex}`;
                }
                
                data.push(item);
            });
            
            return data;
        }
        
        // Display data for current sheet
        function displayData() {
            const data = allData[currentSheet];
            filteredData = [...data];
            
            // Generate table headers based on first data item
            if (data.length > 0) {
                generateTableHeaders(data[0]);
                populateTable(data);
            } else {
                // Show empty state
                document.getElementById('table-headers').innerHTML = '<th>ไม่มีข้อมูล</th>';
                document.getElementById('table-body').innerHTML = '';
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('record-count').textContent = '0 รายการ';
            }
            
            // Apply any existing filters
            filterData();
        }
        
        // Generate table headers based on data keys
        function generateTableHeaders(dataItem) {
            const headersContainer = document.getElementById('table-headers');
            headersContainer.innerHTML = '';
            
            // Get headers from data item keys
            const headers = Object.keys(dataItem);
            
            // Remove id field from display (used internally)
            const displayHeaders = headers.filter(h => h !== 'id' && h !== 'row_id');
            
            // Limit to first 7 columns for better display
            const limitedHeaders = displayHeaders.slice(0, 7);
            
            // Create header cells
            limitedHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headersContainer.appendChild(th);
            });
            
            // Add action column
            const actionTh = document.createElement('th');
            actionTh.textContent = 'ดำเนินการ';
            headersContainer.appendChild(actionTh);
        }
        
        // Populate table with data
        function populateTable(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('record-count').textContent = '0 รายการ';
                return;
            }
            
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('record-count').textContent = `${data.length} รายการ`;
            
            // Get headers from first data item
            const headers = Object.keys(data[0]);
            const displayHeaders = headers.filter(h => h !== 'id' && h !== 'row_id').slice(0, 7);
            
            // Create rows
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Create data cells for display headers
                displayHeaders.forEach(header => {
                    const cell = document.createElement('td');
                    const value = item[header] || '';
                    
                    // Format special fields
                    if (header.toLowerCase().includes('สถานะ') || header.toLowerCase().includes('status')) {
                        const statusClass = getStatusClass(value);
                        cell.innerHTML = `<span class="badge-status ${statusClass}">${value}</span>`;
                    } else if (header.toLowerCase().includes('งบ') || header.toLowerCase().includes('budget') || header.toLowerCase().includes('amount')) {
                        cell.textContent = formatCurrency(value);
                    } else if (header.toLowerCase().includes('date') || header.toLowerCase().includes('วันที่')) {
                        cell.textContent = formatDate(value);
                    } else {
                        // Truncate long text
                        cell.textContent = value.length > 50 ? value.substring(0, 50) + '...' : value;
                    }
                    
                    row.appendChild(cell);
                });
                
                // Add action cell
                const actionCell = document.createElement('td');
                actionCell.innerHTML = `
                    <button class="btn btn-sm btn-outline-primary view-details-btn" data-id="${item.id}">
                        <i class="fas fa-eye me-1"></i>ดูรายละเอียด
                    </button>
                `;
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to view details buttons
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    showProjectDetails(itemId);
                });
            });
        }
        
        // Filter data based on search and filters
        function filterData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            
            let data = allData[currentSheet];
            
            // Apply search filter
            if (searchTerm) {
                data = data.filter(item => {
                    return Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                data = data.filter(item => {
                    // Look for status in any field
                    return Object.values(item).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(statusFilter);
                        }
                        return false;
                    });
                });
            }
            
            // Apply additional filters
            if (activeFilter !== 'all') {
                switch(activeFilter) {
                    case 'recent':
                        // Filter for recent items (look for dates)
                        const oneWeekAgo = new Date();
                        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                        data = data.filter(item => {
                            // Find date field
                            for (const [key, value] of Object.entries(item)) {
                                if (key.toLowerCase().includes('date') && value) {
                                    const itemDate = new Date(value);
                                    if (!isNaN(itemDate)) {
                                        return itemDate > oneWeekAgo;
                                    }
                                }
                            }
                            return false;
                        });
                        break;
                    case 'budget-high':
                        // Filter for high budget items
                        data = data.filter(item => {
                            // Find budget field
                            for (const [key, value] of Object.entries(item)) {
                                if ((key.toLowerCase().includes('budget') || key.toLowerCase().includes('งบ') || key.toLowerCase().includes('amount')) && value) {
                                    const budget = parseFloat(value.toString().replace(/[^0-9.-]+/g, ''));
                                    return budget > 50000;
                                }
                            }
                            return false;
                        });
                        break;
                    case 'budget-low':
                        // Filter for low budget items
                        data = data.filter(item => {
                            // Find budget field
                            for (const [key, value] of Object.entries(item)) {
                                if ((key.toLowerCase().includes('budget') || key.toLowerCase().includes('งบ') || key.toLowerCase().includes('amount')) && value) {
                                    const budget = parseFloat(value.toString().replace(/[^0-9.-]+/g, ''));
                                    return budget > 0 && budget <= 50000;
                                }
                            }
                            return false;
                        });
                        break;
                }
            }
            
            filteredData = data;
            populateTable(data);
        }
        
        // Show project details in modal
        function showProjectDetails(itemId) {
            // Find the item
            const item = allData[currentSheet].find(i => i.id === itemId);
            
            if (!item) return;
            
            // Build details content
            let content = '<div class="row">';
            
            // Split fields into two columns for better display
            const fields = Object.entries(item);
            const midPoint = Math.ceil(fields.length / 2);
            
            content += '<div class="col-md-6"><h6>ข้อมูลโครงการ</h6>';
            for (let i = 0; i < midPoint; i++) {
                const [key, value] = fields[i];
                if (key !== 'id') {
                    content += `<p><strong>${key}:</strong> ${formatFieldValue(key, value)}</p>`;
                }
            }
            content += '</div>';
            
            content += '<div class="col-md-6"><h6>รายละเอียดเพิ่มเติม</h6>';
            for (let i = midPoint; i < fields.length; i++) {
                const [key, value] = fields[i];
                if (key !== 'id') {
                    content += `<p><strong>${key}:</strong> ${formatFieldValue(key, value)}</p>`;
                }
            }
            content += '</div>';
            
            content += '</div>';
            
            // Set modal content
            document.getElementById('project-details-content').innerHTML = content;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('projectDetailsModal'));
            modal.show();
        }
        
        // Helper functions
        function showLoading(show) {
            document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            // Create error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of container
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function showSuccess(message) {
            // Create success alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of container
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
        
        function getStatusClass(status) {
            if (!status) return '';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('รอ') || statusLower.includes('pending') || statusLower.includes('waiting')) return 'status-pending';
            if (statusLower.includes('อนุมัติ') || statusLower.includes('approved') || statusLower.includes('ผ่าน')) return 'status-approved';
            if (statusLower.includes('ไม่อนุมัติ') || statusLower.includes('rejected') || statusLower.includes('ไม่ผ่าน')) return 'status-rejected';
            if (statusLower.includes('ตรวจ') || statusLower.includes('verified') || statusLower.includes('สำเร็จ')) return 'status-verified';
            return '';
        }
        
        function formatCurrency(amount) {
            if (!amount) return '-';
            
            // Extract numbers from string
            const num = parseFloat(amount.toString().replace(/[^0-9.-]+/g, ''));
            if (isNaN(num)) return amount;
            
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 0
            }).format(num);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            // Try to parse date
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString;
            }
            
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function formatFieldValue(key, value) {
            if (!value) return '-';
            
            const keyLower = key.toLowerCase();
            const valueStr = value.toString();
            
            if (keyLower.includes('status') || keyLower.includes('สถานะ')) {
                const statusClass = getStatusClass(valueStr);
                return `<span class="badge-status ${statusClass}">${valueStr}</span>`;
            }
            
            if (keyLower.includes('budget') || keyLower.includes('งบ') || keyLower.includes('amount') || keyLower.includes('เงิน')) {
                return formatCurrency(valueStr);
            }
            
            if (keyLower.includes('date') || keyLower.includes('วันที่')) {
                return formatDate(valueStr);
            }
            
            return valueStr;
        }
    </script>
</body>
</html>
